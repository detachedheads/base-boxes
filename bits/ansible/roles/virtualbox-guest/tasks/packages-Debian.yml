---
  - name: Get the current list of installed packages
    shell: dpkg-query -l > /tmp/pre-virtualbox-guest-packages.txt

  - name: Install necessary packages for compiling
    apt:
      name={{ item }}
      update_cache=yes
      install-recommends=no
      state=present
    with_items:
      - bzip2
      - dkms
      - gcc
      - make

  - name: Get the packages installed after bringing in the necessary ones
    shell: dpkg-query -l > /tmp/post-virtualbox-guest-packages.txt

  - name: Determine what packages were actually installed
    shell: diff /tmp/pre-virtualbox-guest-packages.txt /tmp/post-virtualbox-guest-packages.txt|awk '/>/{print $3}'
    register: installed